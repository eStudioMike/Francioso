// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id          String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String           @unique
  description String?
  level       Int              @default(0)
  createdAt   DateTime         @default(now()) @map("created_at")
  // relations
  userRoles   UserRole[]
  rolePerms   RolePermission[]
}

model Permission {
  id          String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String           @unique
  name        String?
  description String?
  createdAt   DateTime         @default(now()) @map("created_at")
  rolePerms   RolePermission[]
}

model RolePermission {
  roleId       String @map("role_id") @db.Uuid
  permissionId String @map("permission_id") @db.Uuid

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model User {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String   @unique
  passwordHash  String   @map("password_hash")
  name          String?
  phone         String?
  metadata      Json?    @default("{}")
  isActive      Boolean  @default(true) @map("is_active")
  emailVerified Boolean  @default(false) @map("email_verified")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @default(now()) @map("updated_at")

  userRoles        UserRole[]
  sessions         Session[]
  companies        Company[]   @relation("CompanyOwner")
  quotesCreated    Quote[]     @relation("QuoteCreatedBy")
  quotesOwner      Quote[]     @relation("QuoteOwner")
  contractsCreated Contract[]  @relation("ContractCreatedBy")
  contractsOwner   Contract[]  @relation("ContractOwner")
  actionLogs       ActionLog[]
}

model UserRole {
  userId String @map("user_id") @db.Uuid
  roleId String @map("role_id") @db.Uuid

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model Session {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String?   @map("user_id") @db.Uuid
  tokenId   String    @unique @map("token_id")
  tokenHash String?   @map("token_hash")
  ipAddr    String?   @map("ip_addr")
  userAgent String?   @map("user_agent")
  createdAt DateTime  @default(now()) @map("created_at")
  expiresAt DateTime? @map("expires_at")
  revoked   Boolean   @default(false)
  revokedAt DateTime? @map("revoked_at")
  meta      Json?     @default("{}")

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], name: "idx_sessions_user")
  @@map("sessions")
}

model Company {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  vatNumber String?  @map("vat_number")
  taxCode   String?  @map("tax_code")
  website   String?
  phone     String?
  email     String?
  address1  String?  @map("address_line1")
  address2  String?  @map("address_line2")
  postcode  String?  @map("postcode")
  city      String?
  region    String?
  country   String?
  ownerId   String?  @map("owner_id") @db.Uuid
  metadata  Json?    @default("{}")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @map("updated_at")

  owner     User?      @relation("CompanyOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  quotes    Quote[]
  contracts Contract[]
}

model QuoteStatus {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code      String   @unique
  label     String
  createdAt DateTime @default(now()) @map("created_at")
  quotes    Quote[] // relazione uno-a-molti con Quote

  @@map("quote_statuses")
}

model Quote {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  quoteNumber    String    @unique @map("quote_number")
  companyId      String?   @map("company_id") @db.Uuid
  ownerId        String?   @map("owner_id") @db.Uuid
  statusId       String?   @map("status_id") @db.Uuid
  issueDate      DateTime? @map("issue_date")
  validUntil     DateTime? @map("valid_until")
  currency       String?   @default("EUR")
  subtotal       Float     @default(0)
  discountAmount Float     @default(0) @map("discount_amount")
  taxAmount      Float     @default(0) @map("tax_amount")
  total          Float     @default(0)
  notes          String?
  terms          String?
  metadata       Json?     @default("{}")
  createdBy      String?   @map("created_by") @db.Uuid
  updatedBy      String?   @map("updated_by") @db.Uuid
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @default(now()) @map("updated_at")

  company       Company?          @relation(fields: [companyId], references: [id], onDelete: SetNull)
  owner         User?             @relation("QuoteOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  createdByUser User?             @relation("QuoteCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  items         QuoteItem[]
  versions      QuoteVersion[]
  attachments   QuoteAttachment[]
  quoteStatus   QuoteStatus?      @relation(fields: [quoteStatusId], references: [id])
  quoteStatusId String?           @db.Uuid
}

model QuoteItem {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  quoteId     String   @map("quote_id") @db.Uuid
  position    Int      @default(0)
  description String
  quantity    Float    @default(1)
  unitPrice   Float    @default(0) @map("unit_price")
  discount    Float?   @default(0)
  taxRate     Float?   @default(0) @map("tax_rate")
  lineTotal   Float    @default(0) @map("line_total")
  metadata    Json?    @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")

  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@map("quote_items")
}

model QuoteVersion {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  quoteId       String   @map("quote_id") @db.Uuid
  versionNumber Int      @map("version_number")
  snapshot      Json
  createdBy     String?  @map("created_by") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at")

  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@unique([quoteId, versionNumber], name: "uq_quote_versions_quote_version")
  @@map("quote_versions")
}

model QuoteAttachment {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  quoteId     String   @map("quote_id") @db.Uuid
  filename    String
  contentType String?  @map("content_type")
  url         String?
  sizeBytes   Int?     @map("size_bytes")
  uploadedBy  String?  @map("uploaded_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")

  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@map("quote_attachments")
}

model ContractStatus {
  id        String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code      String     @unique
  label     String
  createdAt DateTime   @default(now()) @map("created_at")
  contracts Contract[] // relazione uno-a-molti con Contract

  @@map("contract_statuses")
}

model Contract {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contractNumber String          @unique @map("contract_number")
  quoteId        String?         @map("quote_id") @db.Uuid
  companyId      String?         @map("company_id") @db.Uuid
  ownerId        String?         @map("owner_id") @db.Uuid
  statusId       String?         @map("status_id") @db.Uuid
  issueDate      DateTime?       @map("issue_date")
  startDate      DateTime?       @map("start_date")
  endDate        DateTime?       @map("end_date")
  currency       String?         @default("EUR")
  subtotal       Float?          @default(0)
  discountAmount Float?          @default(0) @map("discount_amount")
  taxAmount      Float?          @default(0) @map("tax_amount")
  total          Float?          @default(0)
  paymentTerms   String?         @map("payment_terms")
  signedBy       Json?           @map("signed_by")
  signedAt       DateTime?       @map("signed_at")
  isExecuted     Boolean?        @default(false) @map("is_executed")
  metadata       Json?           @default("{}")
  createdBy      String?         @map("created_by") @db.Uuid
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @default(now()) @map("updated_at")
  status         ContractStatus? @relation(fields: [statusId], references: [id], onDelete: SetNull)

  company       Company?             @relation(fields: [companyId], references: [id], onDelete: SetNull)
  owner         User?                @relation("ContractOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  createdByUser User?                @relation("ContractCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  items         ContractItem[]
  attachments   ContractAttachment[]
}

model ContractItem {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contractId  String   @map("contract_id") @db.Uuid
  position    Int      @default(0)
  description String
  quantity    Float    @default(1)
  unitPrice   Float    @default(0) @map("unit_price")
  discount    Float?   @default(0)
  taxRate     Float?   @default(0) @map("tax_rate")
  lineTotal   Float    @default(0) @map("line_total")
  metadata    Json?    @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@map("contract_items")
}

model ContractAttachment {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contractId  String   @map("contract_id") @db.Uuid
  filename    String
  contentType String?  @map("content_type")
  url         String?
  sizeBytes   Int?     @map("size_bytes")
  uploadedBy  String?  @map("uploaded_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@map("contract_attachments")
}

model ActionLog {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String?  @map("user_id") @db.Uuid
  action       String
  resourceType String?  @map("resource_type")
  resourceId   String?  @map("resource_id")
  details      Json?    @default("{}")
  ipAddr       String?  @map("ip_addr")
  userAgent    String?  @map("user_agent")
  createdAt    DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("action_logs")
}
